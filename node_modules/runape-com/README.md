
# ComAPI

The `comapi` provides simple tools for your applications to authenticate to and interact with RunApe over the WebAPI. Find out what the API endpoints and their different methods can do, or try them out directly from our [API page](https://runape.com/Support/API).

The endpoints reachable via the API are listed in the table below.

| **Name**     | **Description**                                              |
| ------------ | ------------------------------------------------------------ |
| ApiAccess    | Get or change the API and Scriber keys.                      |
| Hunter       | Creates new monitors.                                        |
| Quotas       | Manages your [Quotas](https://runape.com/Support/Help?page=quotas) :blue_book:. |
| Webscape     | Manages your monitors. Supports live monitor update notifications via [WebSockets](https://socket.io/). |
| Verification | Verifies new email addresses in order to activate them.      |

The host and the base URL to which the endpoint paths are appended is https://runape.com/API/.

An example of the GET request: `https://runape.com/API/Webscape/GetMonitor/1KErMbAWezRA`.

Any *API logic* you might need for managing your monitors programmatically can be executed by the [Monitor script](https://runape.com/Support/Help?page=monitor_script) :blue_book:.

## Loading

#### Webpage include 

```HTML
<script src="https://runape.com/scripts/releasebin/comapi.js"></script>
```

#### Script page injection

```javascript
//CasperJS
this.page.includeJs("https://runape.com/scripts/releasebin/comapi.js"); //via URL
this.page.injectScript("./Scripts/node_modules/runape-com/comapi.js");  //via fs from your folder

//Puppeteer
const comapiPath = require.resolve('/Scripts/node_modules/runape-com');
await page.addScriptTag({ path: comapiPath });
```

#### Require module

```javascript 
//CasperJS or Puppeteer
var ComApi = require("runape-com");
```

## Functions

The ComApi implements following functions: `getToken, isTokenSet, releaseToken, sendGet, sendPost, getUpdates, getResourceIds, onErrorDefault, promisify`. See the [ComApi code samples](https://github.com/RunApe/MonitorScripts/tree/master/samples/comapi) that show how they are used in different environments.

---- 
```javascript
ComApi.getToken({
    credentials: {a: "apiKey"} or {u: "UserName", p: "Password"}
    onSetToken: setCallback, //Store token on client device
    onGetToken: getCallback, //Get token from client device
    onRenewExpired: init,    //Reinit getToken when renewal token expires
    isRenewForced: boolean   //Renew on each getToken call (optional)
}, onSuccess, onError);
```
Before using any of the API methods your application needs to call the `getToken` function once. Calling the `getToken` authenticates and initiates the [JWT access token](https://en.wikipedia.org/wiki/JSON_Web_Token) exchange. The access token is required for increased security and is used in all subsequent requests that use `sendPost`, `sendGet` and `getUpdates`. 

Your `apiKey` is displayed in the [Site Settings](https://runape.com/Support/Help?page=site_settings) :blue_book: on the Webscape page. When the new access token is generated, the `onSetToken` callback is called to store the token on the client device. The `onGetToken` callback is called to get the stored token on every call to `sendPost`, `sendGet` and `getUpdates`. The storage callbacks can be implemented to use the browser's `localStorage` or the file storage (`runape-fstore` module). 

The `onRenewExpired` is called when the JWT access token is about to expire and a renewal token is requested. Usually the `onRenewExpired` calls the same `ComApi.getToken` function that initiated the token retrieval.
***

```javascript
ComApi.releaseToken(onSuccess, onError);
```
It is a good practice to call the `releaseToken` when ending the communication with RunApe.
***

```javascript
ComApi.sendPost(request, endpoint, onSuccess, onError);
```
For any POST requests. The `request` must be an object, even if empty. The `endpoint` is a concatenation of the available endpoint and its API method. For example `Webscape/UpdateMonitor/`.
***

```javascript
ComApi.sendGet(endpoint, onSuccess, onError);
```
For any GET requests. The `endpoint` is a concatenation of the available endpoint and its API method. For example `Quotas/GetCreditsAndCosts/`
***

```javascript
ComApi.getUpdates(onUpdateSuccess, onUpdateError);
```
The `getUpdates` calls the `onUpdateSuccess` when a monitor has changed or a new monitor was created. The `onUpdateSuccess` takes two input arguments, the `operation` and `monitorId` where the operation can be `update` or `newmonitor`. 

```javascript
/* Example - Get the monitor when it has been updated */
function onUpdateSuccess(operation, monitorId) {
	ComApi.sendGet("Webscape/GetMonitor/" + monitorId, onGetSuccess, onGetError);
}
```
***

```javascript
Object = ComApi.getResourceIds(endpointName);
```
The `getResourceIds` is used when you need to implement your own `sendPost` and `sendGet` functions to communicate with a given endpoint. A call to this function for a given `endpointName` returns the `moduleId` and `tabId` required for authentication with the endpoint.

```javascript
/* Example */
var moduleTab = ComApi.getResourceIds("webscape/");
xhr.setRequestHeader("ModuleId", moduleTab.ModuleId);
xhr.setRequestHeader("TabId", moduleTab.TabId);
```
***

```javascript
ComApi.onErrorDefault;
```
If the `onError` is not set on a ComApi function the `onErrorDefault` is called. You can set the `onErrorDefault` as your global error handling callback instead of setting the `onError` on each ComApi function.

```javascript
/* Example */
ComApi.onErrorDefault = function(xhr){
    console.log("Request failed with status " + xhr.status);
}
```
***

```javascript
ComApi.promisify(fn);
```
The `promisify` takes any of the ComApi functions that have `onSuccess` and `onError` as last arguments and returns a version that returns promises. The returned version takes the leading arguments as usual, only the two last callback arguments are omitted.

```javascript
/* Example */
const getToken = ComApi.promisify(ComApi.getToken);
getToken(args).then((token) => {
  // Save the token
}).catch((error) => {
  // Handle the error
}).finally() => {
  // Always called
}
```
